import e from"mitt";import{__extends as t,__assign as i,__awaiter as r,__generator as n,__spreadArray as a}from"tslib";import{fabric as o}from"fabric";import c from"resize-observer-polyfill";import{debounce as l}from"lodash-es";import s from"hammerjs";import{v4 as u}from"uuid";var b,h,d,p={TRIGGER_TOOL:"trigger_tool",CREATE_OBJ:"create_obj",DELETE_OBJ:"delete_obj",OBJECT_TYPE_IN_CANVAS_CHANGE:"object_type_in_canvas_change",UPDATE_CONTROLLER_BTN:"update_controller_btn",SAVE_SNAPSHOT:"save_snapshot",CANVAS_IMAGE_LOADED:"canvas_image_loaded",EDITING_ENTERED:"editing_entered",EDITING_EXITED:"editing_exited",READY:"correct_tool_ready",PAN_START:"pan_start",PAN_MOVE:"pan_move",PAN_END:"pan_end",TOUCH:"touch"},f=function(){function t(){Object.assign(this,e())}return Object.defineProperty(t.prototype,"emit",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.emit.apply(this,e)}}),Object.defineProperty(t.prototype,"on",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.on.apply(this,e)}}),t}();!function(e){e[e.Text=1]="Text",e[e.Circle=2]="Circle",e[e.WavyLine=3]="WavyLine",e[e.Seal=4]="Seal",e[e.Pencil=5]="Pencil",e[e.Remark=6]="Remark",e[e.Praise=7]="Praise",e[e.Right=8]="Right",e[e.Wrong=9]="Wrong",e[e.NotCompleteRight=10]="NotCompleteRight",e[e.Zoom=11]="Zoom",e[e.Rotate=12]="Rotate",e[e.Flip=13]="Flip",e[e.Clean=14]="Clean",e[e.Undo=15]="Undo"}(b||(b={})),function(e){e[e.In=1]="In",e[e.Out=2]="Out"}(h||(h={})),function(e){e[e.EncourageOfSeal=1]="EncourageOfSeal",e[e.ExcellentOfSeal=2]="ExcellentOfSeal",e[e.PerfectOfSeal=3]="PerfectOfSeal",e[e.UncorrectOfSeal=4]="UncorrectOfSeal",e[e.GreatOfSeal=5]="GreatOfSeal",e[e.NotCompleteRight=6]="NotCompleteRight",e[e.Right=7]="Right",e[e.Wrong=8]="Wrong",e[e.Praise=9]="Praise"}(d||(d={}));var g=e();o.Object.prototype.transparentCorners=!1,o.Object.prototype.cornerColor="white",o.Object.prototype.borderColor="white",o.Object.prototype.borderScaleFactor=2;var _=document.createElement("img");function y(e,t,i,r,n){var a=this.cornerSize;e.save(),e.translate(t,i),e.rotate(o.util.degreesToRadians(n.angle)),e.drawImage(_,-a/2,-a/2,a,a),e.restore()}_.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMC4xNjQwNjIiIHk9IjAuMzA1NjY0IiB3aWR0aD0iNDkuMzg4IiBoZWlnaHQ9IjQ5LjM4OCIgcng9IjI0LjY5NCIgZmlsbD0id2hpdGUiLz4KPGcgb3BhY2l0eT0iMC42NSI+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMjAuNDQ3MSAxOS45OTg1QzE5LjcxMDggMTkuOTk4NSAxOS4yMjcgMTkuMjI5NyAxOS41NDU2IDE4LjU2NThMMjAuOTg1NiAxNS41NjU5QzIxLjE1MiAxNS4yMTkyIDIxLjUwMjUgMTQuOTk4NiAyMS44ODcxIDE0Ljk5ODZIMjcuODI4NUMyOC4yMTMxIDE0Ljk5ODYgMjguNTYzNiAxNS4yMTkyIDI4LjczIDE1LjU2NTlMMzAuMTcgMTguNTY1OEMzMC40ODg2IDE5LjIyOTcgMzAuMDA0OCAxOS45OTg1IDI5LjI2ODUgMTkuOTk4NUgyMC40NDcxWk0yMy4yNTkyIDE3Ljk5ODZDMjIuNjYwMiAxNy45OTg2IDIyLjMwMjkgMTcuMzMxIDIyLjYzNTIgMTYuODMyNkMyMi43NzQzIDE2LjYyMzkgMjMuMDA4NCAxNi40OTg2IDIzLjI1OTIgMTYuNDk4NkgyNi40NTY0QzI2LjcwNzEgMTYuNDk4NiAyNi45NDEzIDE2LjYyMzkgMjcuMDgwNCAxNi44MzI2QzI3LjQxMjcgMTcuMzMxIDI3LjA1NTQgMTcuOTk4NiAyNi40NTY0IDE3Ljk5ODZIMjMuMjU5MloiIGZpbGw9IiM3MDc4OEMiLz4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xNy4zNTg0IDMxLjk5NzhDMTcuMzU4NCAzMy42NTQ2IDE4LjcwMTUgMzQuOTk3NyAyMC4zNTgzIDM0Ljk5NzdIMjkuMzU4MUMzMS4wMTUgMzQuOTk3NyAzMi4zNTgxIDMzLjY1NDYgMzIuMzU4MSAzMS45OTc4VjE3Ljk5OEgxNy4zNTg0VjMxLjk5NzhaTTIxLjg1ODQgMjMuOTk4MUMyMS44NTg0IDIzLjQ0NTggMjIuMzA2MSAyMi45OTgxIDIyLjg1ODQgMjIuOTk4MUMyMy40MTA3IDIyLjk5ODEgMjMuODU4NCAyMy40NDU4IDIzLjg1ODQgMjMuOTk4MVYyOC45OThDMjMuODU4NCAyOS41NTAzIDIzLjQxMDcgMjkuOTk4IDIyLjg1ODQgMjkuOTk4QzIyLjMwNjEgMjkuOTk4IDIxLjg1ODQgMjkuNTUwMyAyMS44NTg0IDI4Ljk5OFYyMy45OTgxWk0yNi44NTgxIDIyLjk5ODRDMjYuMzA1OCAyMi45OTg0IDI1Ljg1ODEgMjMuNDQ2MSAyNS44NTgxIDIzLjk5ODNWMjguOTk4MkMyNS44NTgxIDI5LjU1MDUgMjYuMzA1OCAyOS45OTgyIDI2Ljg1ODEgMjkuOTk4MkMyNy40MTA0IDI5Ljk5ODIgMjcuODU4MSAyOS41NTA1IDI3Ljg1ODEgMjguOTk4MlYyMy45OTgzQzI3Ljg1ODEgMjMuNDQ2MSAyNy40MTA0IDIyLjk5ODQgMjYuODU4MSAyMi45OTg0WiIgZmlsbD0iIzcwNzg4QyIvPgo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTM0LjM1NzUgMTguOTk4QzM0LjM1NzUgMTkuNTUwMyAzMy45MDk4IDE5Ljk5OCAzMy4zNTc1IDE5Ljk5OEgxNi4zNTc5QzE1LjgwNTYgMTkuOTk4IDE1LjM1NzkgMTkuNTUwMyAxNS4zNTc5IDE4Ljk5OEMxNS4zNTc5IDE4LjQ0NTggMTUuODA1NiAxNy45OTggMTYuMzU3OSAxNy45OThIMzMuMzU3NUMzMy45MDk4IDE3Ljk5OCAzNC4zNTc1IDE4LjQ0NTggMzQuMzU3NSAxOC45OThaIiBmaWxsPSIjNzA3ODhDIi8+CjwvZz4KPC9zdmc+Cg==";var v=function(e){function r(t,r,n,a,o){var c=e.call(this)||this;return Object.defineProperty(c,"isKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"isOn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"_triggerParams",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"externalParams",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"correctId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"_config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"_cacheObjects",{enumerable:!0,configurable:!0,writable:!0,value:[]}),c.correctId=t,c._type=r,c.canvas=n,c.isKeep=a,c._config=i({},o),g.on("".concat(c.correctId,":").concat(p.TRIGGER_TOOL),c.trigger.bind(c)),c}return t(r,e),Object.defineProperty(r.prototype,"trigger",{enumerable:!1,configurable:!0,writable:!0,value:function(e){(null==e?void 0:e.actionType)===this._type?(this._triggerParams=e.params,this.externalParams=e.externalParams,this._handleOn()):e&&!e.isKeep||this._handleOff()}}),Object.defineProperty(r.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.isOn=!0}}),Object.defineProperty(r.prototype,"_handleOff",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.isOn=!1}}),Object.defineProperty(r.prototype,"addListener",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i,r=this;this._cacheObjects.push(e),e.__actionType=this._type,e.__externalParams=this.externalParams,this._setOriginalViewportTransformBeforeModified(e),g.emit("".concat(this.correctId,":").concat(p.SAVE_SNAPSHOT),this._undoAdd(e)),e.controls.deleteControl=(i=function(e,t){if(null==t?void 0:t.target){var i=t.target,r=i.canvas;g.emit("".concat(this.correctId,":").concat(p.SAVE_SNAPSHOT),this._undoRemove(i,r)),function(e,t){var i=t.target,r=i.canvas;r.remove(i),r.requestRenderAll()}(0,t)}}.bind(this),new o.Control({x:.5,y:-.5,touchSizeX:49,touchSizeY:49,cursorStyle:"pointer",mouseUpHandler:i,render:y,cornerSize:49})),t?this._onAdded():e.on("added",this._onAdded.bind(this)),e.on("removed",this._removed.bind(this)),e.on("modified",(function(t){g.emit("".concat(r.correctId,":").concat(p.SAVE_SNAPSHOT),r._undoModified(e,e.originalViewportTransform)),r._setOriginalViewportTransformBeforeModified(e)}))}}),Object.defineProperty(r.prototype,"_onAdded",{enumerable:!1,configurable:!0,writable:!0,value:function(){g.emit("".concat(this.correctId,":").concat(p.CREATE_OBJ),{__actionType:this._type,__externalParams:this.externalParams})}}),Object.defineProperty(r.prototype,"_removed",{enumerable:!1,configurable:!0,writable:!0,value:function(){g.emit("".concat(this.correctId,":").concat(p.DELETE_OBJ),{__actionType:this._type,__externalParams:this.externalParams})}}),Object.defineProperty(r.prototype,"_undoModified",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return function(){e.set(t),e.canvas.renderAll()}}}),Object.defineProperty(r.prototype,"_undoAdd",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return function(){e.canvas.remove(e)}}}),Object.defineProperty(r.prototype,"_undoRemove",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return function(){t.add(e)}}}),Object.defineProperty(r.prototype,"_setOriginalViewportTransformBeforeModified",{enumerable:!1,configurable:!0,writable:!0,value:function(e){e.originalViewportTransform={width:e.width,height:e.height,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,angle:e.angle,strokeWidth:e.strokeWidth,top:e.top,left:e.left,text:e.text}}}),Object.defineProperty(r.prototype,"updateConfig",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._config=i(i({},this._config),e)}}),Object.defineProperty(r.prototype,"triggerParams",{get:function(){return this._triggerParams},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"type",{get:function(){return this._type},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){g.off("".concat(this.correctId,":").concat(p.TRIGGER_TOOL),this.trigger),this._cacheObjects.forEach((function(e){var t;null===(t=null==e?void 0:e.off)||void 0===t||t.call(e)})),this._cacheObjects=null}}),Object.defineProperty(r.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),r}(f),m={opacity:.5,fill:"transparent",stroke:"rgb(255, 0, 0)",strokeWidth:2},O=function(e){function r(t,r,n,a,o){void 0===a&&(a=!0);var c=e.call(this,t,r,n,a,o)||this;return Object.defineProperty(c,"_curEllipse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"_downPointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),c._config=i(i({},m),c._config),c}return t(r,e),Object.defineProperty(r.prototype,"_create",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=new o.Ellipse(i(i({},this._config),e));return this.addListener(t),this.canvas.add(t),t}}),Object.defineProperty(r.prototype,"mousedown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&(this._downPointer=e,this._curEllipse=this._create({top:e.y,left:e.x}),this.canvas.skipTargetFind=!0)}}),Object.defineProperty(r.prototype,"mousemove",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this.isOn&&this._curEllipse){var t=Math.abs(this._downPointer.x-e.x)/2,i=Math.abs(this._downPointer.y-e.y)/2;this._curEllipse.set({rx:t,ry:i,top:e.y>this._downPointer.y?this._downPointer.y:this._downPointer.y-2*i,left:e.x>this._downPointer.x?this._downPointer.x:this._downPointer.x-2*t}),this.canvas.requestRenderAll()}}}),Object.defineProperty(r.prototype,"mouseup",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&this._curEllipse&&(JSON.stringify(this._downPointer)===JSON.stringify(e)?this._curEllipse&&this.canvas.remove(this._curEllipse):(this._curEllipse.set("opacity",1),this.canvas.setActiveObject(this._curEllipse)),this.canvas.skipTargetFind=!1,this.canvas.requestRenderAll(),this._curEllipse=null)}}),Object.defineProperty(r.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),r}(v);function P(e){return new Promise((function(t,i){o.Image.fromURL(e,(function(e,r){r?i(r):t(e)}),{crossOrigin:"anonymous"})}))}var j={};function w(e){return r(this,void 0,void 0,(function(){var t,i,r,a,o,c;return n(this,(function(n){for(t=[],i=Object.entries(e),r=function(e,i){j[e]||t.push(j[e]=P(i).then((function(t){return j[e]=t,t})).catch((function(e){throw new Error(e)})))},a=0,o=i;a<o.length;a++)r((c=o[a])[0],c[1]);return 0===t.length?[2,Promise.resolve({success:!0})]:[2,Promise.all(t).then((function(e){return{success:!0}})).catch((function(e){return{success:!1}}))]}))}))}var T,I=function(e){function r(t,i,r,n,a){return void 0===n&&(n=!0),e.call(this,t,i,r,n,a)||this}return t(r,e),Object.defineProperty(r.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.isKeep?e.prototype._handleOn.call(this):this._createImage()}}),Object.defineProperty(r.prototype,"_createImage",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=j[this._triggerParams.insertIconType];i instanceof Promise?i.then((function(i){i.clone(t._onClone.bind(t,e))})):i.clone(this._onClone.bind(this,e))}}),Object.defineProperty(r.prototype,"mousedown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&this._createImage(e)}}),Object.defineProperty(r.prototype,"_onClone",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r,n=e||this._triggerParams.pointer,a=.6*((null===(r=this._config)||void 0===r?void 0:r.scaleX)||1),o=t.width*a,c=t.height*a,l={};n?l={top:n.y,left:n.x}:(Object.hasOwnProperty.call(this._triggerParams,"top")&&(l.top=this._triggerParams.top+c/2),Object.hasOwnProperty.call(this._triggerParams,"left")&&(l.left=this._triggerParams.left+o/2),Object.hasOwnProperty.call(this._triggerParams,"right")&&(l.left=this.canvas.width-this._triggerParams.right-o/2),Object.hasOwnProperty.call(this._triggerParams,"bottom")&&(l.top=this.canvas.height-this._triggerParams.bottom-c/2)),t.set(i({originX:"center",originY:"center",scaleX:a,scaleY:a,angle:-15},l)),t.setControlsVisibility({mb:!1,mt:!1,mr:!1,ml:!1}),this.addListener(t),this.canvas.add(t),this.canvas.renderAll()}}),Object.defineProperty(r.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),r}(v);o.IText.prototype.updateTextareaPosition=(T=o.IText.prototype.updateTextareaPosition,function(){T.apply(this),requestAnimationFrame((function(){}))});var M=function(e){function r(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return Object.defineProperty(o,"defaultFontSize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(o,"_curText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o}return t(r,e),Object.defineProperty(r.prototype,"_create",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,r=this.defaultFontSize*((null===(t=this._config)||void 0===t?void 0:t.scaleX)||1),n=new o.Textbox("",i({editable:!0,editingBorderColor:"#3262FD",fontSize:r,originY:"center",fill:"red",padding:10},e));this.addListener(n),this.canvas.add(n),this.canvas.setActiveObject(n),n.enterEditing(),this._curText=n}}),Object.defineProperty(r.prototype,"mousedown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&(this._curText?this._curText=null:this._create({top:e.y,left:e.x}))}}),Object.defineProperty(r.prototype,"addListener",{enumerable:!1,configurable:!0,writable:!0,value:function(t){var i=this;e.prototype.addListener.call(this,t),t.on("editing:entered",(function(){g.emit("".concat(i.correctId,":").concat(p.EDITING_ENTERED))})),t.on("editing:exited",(function(){g.emit("".concat(i.correctId,":").concat(p.EDITING_EXITED))}))}}),Object.defineProperty(r.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),Object.defineProperty(r.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){e.prototype.destroy.call(this),this._curText=null}}),r}(v),E={rang:4,strokeWidth:2,minPeriod:20},D=function(e){function r(t,r,n,a,o){void 0===a&&(a=!0);var c=e.call(this,t,r,n,a,o)||this;return Object.defineProperty(c,"_curLine",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(c,"_downPointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),c._config=i(i({},E),o),c}return t(r,e),Object.defineProperty(r.prototype,"mousedown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&(this._downPointer=e,this.canvas.skipTargetFind=!0)}}),Object.defineProperty(r.prototype,"mousemove",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&this._downPointer&&(this._downPointer.eq(e)||(this._curLine&&this.canvas.remove(this._curLine),this._draw(e),this.canvas.requestRenderAll()))}}),Object.defineProperty(r.prototype,"mouseup",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&this._downPointer&&(this._downPointer.eq(e)?this._curLine&&this.canvas.remove(this._curLine):(this.addListener(this._curLine,!0),this._curLine.set("opacity",1),this.canvas.setActiveObject(this._curLine)),this.canvas.skipTargetFind=!1,this.canvas.requestRenderAll(),this._curLine=null,this._downPointer=null)}}),Object.defineProperty(r.prototype,"_draw",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=this._caculatePeriodAndNumByDistance(this._downPointer,e),i=t.period,r=t.num,n="M ".concat(this._downPointer.x," ").concat(this._downPointer.y),a=0;a<r;a++){var c=this._downPointer.x+a*i;n+=0==a?" C ".concat(c+i/8," ").concat(this._downPointer.y+this._config.rang,", ").concat(c+3*i/8," ").concat(this._downPointer.y+this._config.rang,", ").concat(c+i/2," ").concat(this._downPointer.y):" S ".concat(c+3*i/8," ").concat(this._downPointer.y+this._config.rang,", ").concat(c+i/2," ").concat(this._downPointer.y),n+=" S ".concat(c+7*i/8," ").concat(this._downPointer.y-this._config.rang,", ").concat(c+i," ").concat(this._downPointer.y)}var l=new o.Point(this._downPointer.x+10,this._downPointer.y),s=o.util.getBisector(this._downPointer,l,e).angle,u=o.util.radiansToDegrees(s);this._curLine=this._create(n,this._downPointer.y<e.y?u:-u)}}),Object.defineProperty(r.prototype,"_caculatePeriodAndNumByDistance",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=e.distanceFrom(t),r=this._config.minPeriod,n=Math.floor(i/r);return i%this._config.minPeriod!=0&&(r=i/++n),{period:r,num:n}}}),Object.defineProperty(r.prototype,"_create",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=new o.Path(e,{fill:"transparent",stroke:"red",originX:"left",originY:"center",strokeWidth:this._config.strokeWidth,angle:t});return this.canvas.add(i),i}}),Object.defineProperty(r.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),r}(v),C=function(e){function i(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return Object.defineProperty(o,"isDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),o._initializeBrush(),o}return t(i,e),Object.defineProperty(i.prototype,"_initializeBrush",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.canvas.freeDrawingBrush;e.color="red",e.width=3,this.canvas.on("path:created",this._onCreated.bind(this))}}),Object.defineProperty(i.prototype,"_onCreated",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.addListener(e.path,!0)}}),Object.defineProperty(i.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){e.prototype._handleOn.call(this),this.canvas.isDrawingMode=!this.isDisabled}}),Object.defineProperty(i.prototype,"_handleOff",{enumerable:!1,configurable:!0,writable:!0,value:function(){e.prototype._handleOff.call(this),this.canvas.isDrawingMode=!1}}),Object.defineProperty(i.prototype,"disable",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isDisabled=e,this.canvas.isDrawingMode=!e&&!!this.isOn}}),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),Object.defineProperty(i.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){e.prototype.destroy.call(this),this.canvas.off("path:created",this._onCreated)}}),i}(v),A=function(e){function i(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return Object.defineProperty(o,"defaultFontSize",{enumerable:!0,configurable:!0,writable:!0,value:32}),o}return t(i,e),Object.defineProperty(i.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.isKeep?e.prototype._handleOn.call(this):this._create()}}),Object.defineProperty(i.prototype,"mousedown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isOn&&this._create(e)}}),Object.defineProperty(i.prototype,"_create",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i=e||this._triggerParams.pointer,r=(null===(t=this._config)||void 0===t?void 0:t.scaleX)||1,n=new o.Textbox("",{editable:!0,fontSize:(this._triggerParams.fontSize||this.defaultFontSize)*r,originY:"center",fill:"red",padding:10,text:this._triggerParams.text}),a={};i?a={top:i.y,left:i.x}:(Object.hasOwnProperty.call(this._triggerParams,"top")&&(a.top=this._triggerParams.top+n.height/2),Object.hasOwnProperty.call(this._triggerParams,"left")&&(a.left=this._triggerParams.left+n.width),Object.hasOwnProperty.call(this._triggerParams,"right")&&(a.left=this.canvas.width-this._triggerParams.right-n.width),Object.hasOwnProperty.call(this._triggerParams,"bottom")&&(a.top=this.canvas.height-this._triggerParams.bottom-n.height/2)),n.set(a),this.addListener(n),this.canvas.add(n),this.canvas.requestRenderAll()}}),Object.defineProperty(i.prototype,"addListener",{enumerable:!1,configurable:!0,writable:!0,value:function(t){var i=this;e.prototype.addListener.call(this,t),t.on("editing:entered",(function(){g.emit("".concat(i.correctId,":").concat(p.EDITING_ENTERED))})),t.on("editing:exited",(function(){g.emit("".concat(i.correctId,":").concat(p.EDITING_EXITED))}))}}),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(v),N=function(e){function r(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return Object.defineProperty(o,"_loadedIcon",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o}return t(r,e),Object.defineProperty(r.prototype,"_onClone",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){t.set(i({top:e.y,left:e.x,originX:"center",originY:"center"},this._config)),this.addListener(t),this.canvas.add(t),this.canvas.requestRenderAll()}}),Object.defineProperty(r.prototype,"mousedown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;this._loadedIcon instanceof Promise?this._loadedIcon.then((function(i){i.clone(t._onClone.bind(t,e))})):this._loadedIcon.clone(this._onClone.bind(this,e))}}),Object.defineProperty(r.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){e.prototype.destroy.call(this),this._loadedIcon=null}}),r}(v),S=function(e){function i(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return o._loadedIcon=j[d.NotCompleteRight],o}return t(i,e),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(N),z=function(e){function i(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return o._loadedIcon=j[d.Right],o}return t(i,e),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(N),k=function(e){function i(t,i,r,n,a){void 0===n&&(n=!0);var o=e.call(this,t,i,r,n,a)||this;return o._loadedIcon=j[d.Wrong],o}return t(i,e),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(N),x=function(e){function i(t,i,r,n,a){void 0===n&&(n=!1);var o=e.call(this,t,i,r,n,a)||this;return Object.defineProperty(o,"OUT_MAX",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(o,"ZOOM_STEP",{enumerable:!0,configurable:!0,writable:!0,value:.1}),o}return t(i,e),Object.defineProperty(i.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){switch(this._triggerParams.type){case h.In:this._zoomIn();break;case h.Out:this._zoomOut()}}}),Object.defineProperty(i.prototype,"_zoomIn",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.canvas.getZoom();this.canvas.setZoom(e+this.ZOOM_STEP)}}),Object.defineProperty(i.prototype,"_zoomOut",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.canvas.getZoom();e-this.ZOOM_STEP>=this.OUT_MAX&&this.canvas.setZoom(e-this.ZOOM_STEP)}}),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(v),L=function(e){function i(t,i,r,n,a){void 0===n&&(n=!1);var o=e.call(this,t,i,r,n,a)||this;return Object.defineProperty(o,"ROTATE_STEP",{enumerable:!0,configurable:!0,writable:!0,value:90}),Object.defineProperty(o,"_curRotate",{enumerable:!0,configurable:!0,writable:!0,value:0}),o}return t(i,e),Object.defineProperty(i.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._rotate()}}),Object.defineProperty(i.prototype,"_rotate",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._curRotate=this._curRotate+this.ROTATE_STEP===360?0:this._curRotate+this.ROTATE_STEP,this.canvas.updateBackgroundImageRotate(this._curRotate)}}),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(v),R=function(e){function i(t,i,r,n,a){return void 0===n&&(n=!1),e.call(this,t,i,r,n,a)||this}return t(i,e),Object.defineProperty(i.prototype,"_handleOn",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._Flip()}}),Object.defineProperty(i.prototype,"_Flip",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.canvas.updateBackgroundImageFlip()}}),Object.defineProperty(i.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){}}),i}(v),Y=function(){function e(){Object.defineProperty(this,"_undoStack",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._undoStack=[]}return Object.defineProperty(e.prototype,"add",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._undoStack.push(e)}}),Object.defineProperty(e.prototype,"pop",{enumerable:!1,configurable:!0,writable:!0,value:function(){return this._undoStack.pop()}}),Object.defineProperty(e.prototype,"clean",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._undoStack=[]}}),Object.defineProperty(e.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._undoStack=null}}),Object.defineProperty(e.prototype,"undoStack",{get:function(){return this._undoStack},enumerable:!1,configurable:!0}),e}(),U=function(){function e(e,t){Object.defineProperty(this,"_curActionType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_curTool",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tools",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_snapshotManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_iconConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_correctId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_isDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this._canvas=t,this._correctId=e,this._snapshotManager=new Y,g.on("".concat(this._correctId,":").concat(p.SAVE_SNAPSHOT),this._onSaveSnapshot.bind(this))}return Object.defineProperty(e.prototype,"_handleActionTypeChange",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,r,n,a=e.actionType,o=e.isKeep;switch(a){case b.Pencil:n=this._createTool(a,o,C);break;case b.Text:n=this._createTool(a,o,M,this._iconConfig);break;case b.Remark:n=this._createTool(a,o,A,this._iconConfig);break;case b.Circle:n=this._createTool(a,o,O);break;case b.WavyLine:n=this._createTool(a,o,D);break;case b.Seal:case b.Praise:n=this._createTool(a,o,I,this._iconConfig);break;case b.Right:n=this._createTool(a,o,z,this._iconConfig);break;case b.Wrong:n=this._createTool(a,o,k,this._iconConfig);break;case b.NotCompleteRight:n=this._createTool(a,o,S,this._iconConfig);break;case b.Zoom:n=this._createTool(a,o,x);break;case b.Rotate:n=this._createTool(a,o,L);break;case b.Flip:n=this._createTool(a,o,R);break;case b.Clean:this.clear();break;case b.Undo:this._undo()}o&&(this._curTool=n,null===(r=(t=this._curTool).disable)||void 0===r||r.call(t,this._isDisabled)),n&&g.emit("".concat(this._correctId,":").concat(p.TRIGGER_TOOL),i({},e))}}),Object.defineProperty(e.prototype,"_createTool",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,r){var n=this._tools[e];return n||(n=this._tools[e]=new i(this._correctId,e,this._canvas,t,r)),n}}),Object.defineProperty(e.prototype,"_undo",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this._snapshotManager.pop();null==e||e()}}),Object.defineProperty(e.prototype,"clear",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t=this._canvas.getObjects();(e=this._canvas).remove.apply(e,t),this._snapshotManager.clean()}}),Object.defineProperty(e.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){Object.values(this._tools).forEach((function(e){e.destroy()})),g.off("".concat(this._correctId,":").concat(p.SAVE_SNAPSHOT),this._onSaveSnapshot),this._snapshotManager.destroy(),this._snapshotManager=null}}),Object.defineProperty(e.prototype,"disable",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i;this._isDisabled=e,null===(i=null===(t=this._curTool)||void 0===t?void 0:t.disable)||void 0===i||i.call(t,e)}}),Object.defineProperty(e.prototype,"setCurActionType",{enumerable:!1,configurable:!0,writable:!0,value:function(e){null!==e&&null!=e?e.isKeep?(this._isSameAction(e)||this._handleActionTypeChange(e),this._curActionType=e.actionType):this._handleActionTypeChange(e):this._cancelCurrentAction()}}),Object.defineProperty(e.prototype,"setIconConfig",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=[b.Seal,b.Praise,b.Right,b.Wrong,b.NotCompleteRight,b.Text,b.Remark];Object.keys(this._tools).forEach((function(r){var n=t._tools[r];i.includes(n.type)&&n.updateConfig(e)})),this._iconConfig=e}}),Object.defineProperty(e.prototype,"_isSameAction",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i,r,n=e.params;if(this._curActionType!==e.actionType)return!1;var a=!1;switch(e.actionType){case b.Remark:a=(null===(t=this._curTool)||void 0===t?void 0:t.triggerParams.text)===n.text;break;case b.Seal:a=(null===(i=this._curTool)||void 0===i?void 0:i.triggerParams.insertIconType)===n.insertIconType;break;case b.Zoom:a=(null===(r=this._curTool)||void 0===r?void 0:r.triggerParams.type)===n.type}return a}}),Object.defineProperty(e.prototype,"_cancelCurrentAction",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._curTool&&g.emit("".concat(this._correctId,":").concat(p.TRIGGER_TOOL),null),this._curActionType=null,this._curTool=null}}),Object.defineProperty(e.prototype,"_onSaveSnapshot",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._snapshotManager.add(e)}}),Object.defineProperty(e.prototype,"curActionType",{get:function(){return this._curActionType},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"curTool",{get:function(){return this._curTool},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"snapshotManager",{get:function(){return this._snapshotManager},enumerable:!1,configurable:!0}),e}(),Z=function(e){function i(t,i,r,n){var a=e.call(this,t,i)||this;Object.defineProperty(a,"_bgImageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"_container",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"_loadedBgImage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"_imgRotate",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(a,"_currentContainerWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"_currentContainerHeight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"minZoomValue",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(a,"_filpX",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(a,"_correctId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"_copyCanvasData",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"_resizeObserver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"isDisabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0});var o=n.container,s=n.copyCanvasData;a._bgImageUrl=n.imageUrl,a._container=o,a._correctId=r,a._copyCanvasData=s,a._currentContainerWidth=a._container.clientWidth,a._currentContainerHeight=a._container.clientHeight;var u=l(a._onContainerResize.bind(a),100);return a._resizeObserver||(a._resizeObserver=new c((function(e,t){for(var i=0,r=e;i<r.length;i++){var n=r[i].contentRect,o=n.width,c=n.height;a._currentContainerWidth===o&&a._currentContainerHeight===c||u(o,c)}}))),a._initialize().then((function(){var e;if(a._updateCanvasSize(),a._copyCanvasData){var t=a._caculateCanvasSize().width;a._updateObjectSizeInCanvas(t/a._copyCanvasData.canvasWidth)}a._updateBackgroundSize(),a.fire(p.CANVAS_IMAGE_LOADED),null===(e=a._resizeObserver)||void 0===e||e.observe(a._container)})),a}return t(i,e),Object.defineProperty(i.prototype,"_initialize",{enumerable:!1,configurable:!0,writable:!0,value:function(){return r(this,void 0,void 0,(function(){var e,t;return n(this,(function(i){switch(i.label){case 0:return this.selection=!1,e=this._createLoadingEle(),this._copyCanvasData?[4,this._loadCopyCanvasData()]:[3,2];case 1:return i.sent(),[3,4];case 2:return t=this,[4,P(this._bgImageUrl)];case 3:t._loadedBgImage=i.sent(),this.setBackgroundImage(this._loadedBgImage,this.renderAll.bind(this)),i.label=4;case 4:return this._container.removeChild(e),[2]}}))}))}}),Object.defineProperty(i.prototype,"_loadCopyCanvasData",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;return new Promise((function(t,i){e.loadFromJSON(e._copyCanvasData.jsonData,t)}))}}),Object.defineProperty(i.prototype,"_updateObjectSizeInCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.getObjects().forEach((function(t){t.set({top:t.top*e,left:t.left*e,scaleX:t.scaleX*e,scaleY:t.scaleY*e}).setCoords()}))}}),Object.defineProperty(i.prototype,"_createLoadingEle",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=document.createElement("img");return e.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCAyMCI+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgc3Ryb2tlPSIjMzI2MkZEIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiIHN0cm9rZS1kYXNoYXJyYXk9IjI2IDE0Ij4KICAgIDxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgYXR0cmlidXRlVHlwZT0iWE1MIiB0eXBlPSJyb3RhdGUiIGR1cj0iMXMiIGZyb209IjAgMTAgMTAiIHRvPSIzNjAgMTAgMTAiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPgogIDwvY2lyY2xlPgogIDx0ZXh0IHg9IjI1IiB5PSIxMCIgZHk9Ii40ZW0iIHRleHQtYW5jaG9yPSJzdGFydCIgZm9udC1zaXplPSIxNnB4IiBmb250LXdlaWdodD0nYm9sZCc+5Yqg6L295LitPC90ZXh0Pgo8L3N2Zz4K",e.width=120,e.height=20,e.style.cssText="position: absolute;top: 50%;left: 50%;margin-left: -60px;margin-top: -10px;",this._container.appendChild(e),e}}),Object.defineProperty(i.prototype,"_onContainerResize",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){this._currentContainerWidth=e,this._currentContainerHeight=t;var i=this.width,r=this._caculateCanvasSize().width;this._updateObjectSizeInCanvas(r/i),this._updateCanvasSize(),this._updateBackgroundSize()}}),Object.defineProperty(i.prototype,"updateBackgroundImageRotate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return void 0===e&&(e=0),r(this,void 0,void 0,(function(){return n(this,(function(t){return this._imgRotate=e,this._updateCanvasSize(),this.getZoom()!=this.minZoomValue&&this.setZoom(this.minZoomValue),this._updateBackgroundSize(),[2]}))}))}}),Object.defineProperty(i.prototype,"updateBackgroundImageFlip",{enumerable:!1,configurable:!0,writable:!0,value:function(){return r(this,void 0,void 0,(function(){return n(this,(function(e){return this._filpX=!("object"==typeof this._loadedBgImage&&!!this._loadedBgImage.flipX),this._updateBackgroundSize(),[2]}))}))}}),Object.defineProperty(i.prototype,"updateBackgroundImage",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return r(this,void 0,void 0,(function(){var i=this;return n(this,(function(r){return this._bgImageUrl=e,P(e).then((function(r){e===i._bgImageUrl&&(i._loadedBgImage=r,i.setBackgroundImage(i._loadedBgImage,(function(){i._imgRotate=0,i._filpX=!1,i._updateBackgroundSize(),i.renderAll(),null==t||t()})))})),[2]}))}))}}),Object.defineProperty(i.prototype,"_updateBackgroundSize",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this._calculateImageSizeByRotate();this._loadedBgImage.set({top:this.height/2,left:this.width/2,scaleX:this.width/e.width,scaleY:this.height/e.height,originX:"center",originY:"center",flipX:this._filpX,angle:this._imgRotate}),this.requestRenderAll()}}),Object.defineProperty(i.prototype,"_calculateImageSizeByRotate",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this._loadedBgImage.width,t=this._loadedBgImage.height;if(this._imgRotate/90%2!=0){var i=e;e=t,t=i}return{width:e,height:t}}}),Object.defineProperty(i.prototype,"_caculateCanvasSize",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,i=this._calculateImageSizeByRotate(),r=i.width/i.height,n=this._currentContainerWidth,a=this._currentContainerHeight;return r>n/a?(t=n,e=n/r):(e=a,t=r*a),{width:t,height:e}}}),Object.defineProperty(i.prototype,"_updateCanvasSize",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this._caculateCanvasSize(),t=e.height;this.setWidth(e.width),this.setHeight(t)}}),Object.defineProperty(i.prototype,"generateImage",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=this.viewportTransform,t=e[0],i=e[3],r=e[4],n=e[5],a=this.getWidth(),o=this.getHeight(),c=this.toDataURL({format:"jpeg",left:r,top:n,width:a*t,height:o*i,multiplier:(a>1e3?1:2)/i}).split(","),l=c[0].match(/:(.*?);/)[1],s=atob(c[1]),u=s.length,b=new Uint8Array(u);u--;)b[u]=s.charCodeAt(u);return new File([b],this._correctId,{type:l})}}),Object.defineProperty(i.prototype,"setZoom",{enumerable:!1,configurable:!0,writable:!0,value:function(t){return e.prototype.setZoom.call(this,t<this.minZoomValue?this.minZoomValue:t),this}}),Object.defineProperty(i.prototype,"zoomToPoint",{enumerable:!1,configurable:!0,writable:!0,value:function(t,i){i=i<this.minZoomValue?this.minZoomValue:i;var r=this._container.getBoundingClientRect(),n=new o.Point(t.x-r.left-(r.width-this.width)/2,t.y-r.top-(r.height-this.height)/2);return e.prototype.zoomToPoint.call(this,n,i),this.setViewportTransform(this.viewportTransform),this}}),Object.defineProperty(i.prototype,"setViewportTransform",{enumerable:!1,configurable:!0,writable:!0,value:function(t){return e.prototype.setViewportTransform.call(this,this._correctViewportTransform(t)),this}}),Object.defineProperty(i.prototype,"_correctViewportTransform",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e[4],i=e[5],r=e[0],n=e[3];return t>0?t=0:t<this.width-this.width*r&&(t=this.width-this.width*r),i>0?i=0:i<this.height-this.height*n&&(i=this.height-this.height*n),[r,e[1],e[2],n,t,i]}}),Object.defineProperty(i.prototype,"loadFromJSON",{enumerable:!1,configurable:!0,writable:!0,value:function(t,i,r){var n=this;return e.prototype.loadFromJSON.call(this,t,(function(){n._loadedBgImage=n.backgroundImage,null==i||i(),n.renderAll()}),r),this}}),Object.defineProperty(i.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._resizeObserver.unobserve(this._container),this._resizeObserver=null}}),Object.defineProperty(i.prototype,"bgImageUrl",{get:function(){return this._bgImageUrl},enumerable:!1,configurable:!0}),i}(o.Canvas),X=function(e){function r(t,i){var r=e.call(this)||this;return Object.defineProperty(r,"canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_container",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_touchWrapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_toolManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_correctId",{enumerable:!0,configurable:!0,writable:!0,value:u()}),Object.defineProperty(r,"_isDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(r,"_prePanX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(r,"_prePanY",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(r,"_preScale",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(r,"_hammerManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_curPinchActiveObject",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_options",{enumerable:!0,configurable:!0,writable:!0,value:{}}),r._container=t.container,r._options=i||{},r._initializeCanvas(t),r._addObjectListener(),r._initializeTouchEvents(),r._toolManager=new U(r._correctId,r.canvas),r}return t(r,e),Object.defineProperty(r.prototype,"_initializeCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this._createCanvasEle(this._container);this.canvas=new Z(t,i({preserveObjectStacking:!0,isDrawingMode:!1,backgroundColor:"#f2f7fe"},this._options),this._correctId,e)}}),Object.defineProperty(r.prototype,"_initializeTouchEvents",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._hammerManager=new s.Manager(this._touchWrapper);var e=new s.Pinch,t=new s.Pan({direction:s.DIRECTION_ALL,threshold:2}),i=new s.Tap({event:"doubletap",taps:2}),r=new s.Tap;this._hammerManager.add([e,t,i,r]),this._hammerManager.on("pinchstart",this._onPinchStart.bind(this)),this._hammerManager.on("panstart",this._onPanStart.bind(this)),this._hammerManager.on("doubletap",this._onDoubleTap.bind(this)),this._hammerManager.on("tap",this._onTap.bind(this))}}),Object.defineProperty(r.prototype,"_onPanStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i;if(this._hammerManager.on("panmove",this._onPanMoveHandle.bind(this)),this._hammerManager.on("panend",this._onPanEndHandle.bind(this)),this._toolManager.curActionType!==b.Pencil||this._isDisabled){if(this.canvas.getActiveObject()&&!this._isDisabled)return void this.emit(p.TOUCH,{isEditing:!0,type:"pan"});[b.WavyLine,b.Circle].includes(this._toolManager.curActionType)&&!this._isDisabled?(null===(i=null===(t=this._toolManager.curTool)||void 0===t?void 0:t.mousedown)||void 0===i||i.call(t,this._getPointOfViewportTransformed(e.srcEvent.offsetX,e.srcEvent.offsetY)),this.emit(p.TOUCH,{type:"pan",isEditing:!0})):(this._prePanX=e.deltaX,this._prePanY=e.deltaY)}else this.emit(p.TOUCH,{isEditing:!0,type:"pan"})}}),Object.defineProperty(r.prototype,"_onPanMoveHandle",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i;if(this.canvas.getActiveObject()&&!this._isDisabled)this.emit(p.TOUCH,{isEditing:!0,type:"pan"});else if(this._toolManager.curActionType!==b.Pencil||this._isDisabled)if([b.WavyLine,b.Circle].includes(this._toolManager.curActionType)&&!this._isDisabled)null===(i=null===(t=this._toolManager.curTool)||void 0===t?void 0:t.mousemove)||void 0===i||i.call(t,this._getPointOfViewportTransformed(e.srcEvent.offsetX,e.srcEvent.offsetY)),this.emit(p.TOUCH,{isEditing:!0,type:"pan"});else{var r=this._pan(e.deltaX-this._prePanX,e.deltaY-this._prePanY);this._prePanX=e.deltaX,this._prePanY=e.deltaY,this.emit(p.TOUCH,{isEditing:r,type:"pan"})}else this.emit(p.TOUCH,{isEditing:!0,type:"pan"})}}),Object.defineProperty(r.prototype,"_onPanEndHandle",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i;this._prePanX=0,this._prePanY=0,[b.WavyLine,b.Circle].includes(this._toolManager.curActionType)&&!this._isDisabled&&(null===(i=null===(t=this._toolManager.curTool)||void 0===t?void 0:t.mouseup)||void 0===i||i.call(t,this._getPointOfViewportTransformed(e.srcEvent.offsetX,e.srcEvent.offsetY))),this.emit(p.TOUCH,{isEditing:!1,type:"pan"}),this._hammerManager.off("panmove",this._onPanMoveHandle),this._hammerManager.off("panend",this._onPanEndHandle)}}),Object.defineProperty(r.prototype,"_onPinchStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._hammerManager.on("pinchend",this._onPinchEndHandle.bind(this)),this._toolManager.curActionType!==b.Pencil||this._isDisabled?(this._isDisabled||(this._curPinchActiveObject=this.canvas.getActiveObject()),this._preScale=e.scale,this._prePanX=e.deltaX,this._prePanY=e.deltaY,this.emit(p.TOUCH,{isEditing:!0,type:"pinch"}),this._hammerManager.on("pinchmove",this._onPinchMoveHandle.bind(this))):this.emit(p.TOUCH,{isEditing:!0,type:"pinch"})}}),Object.defineProperty(r.prototype,"_onPinchMoveHandle",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this._toolManager.curActionType!==b.Pencil||this._isDisabled)if(this._curPinchActiveObject&&!this._isDisabled)this._pinchObject(this._curPinchActiveObject,{x:e.deltaX-this._prePanX,y:e.deltaY-this._prePanY},e.scale-this._preScale),this.emit(p.TOUCH,{isEditing:!0,type:"pinch"});else{this._pinch(new o.Point(e.center.x,e.center.y),e.scale-this._preScale);var t=this._pan(e.deltaX-this._prePanX,e.deltaY-this._prePanY);this.emit(p.TOUCH,{isEditing:t,type:"pinch"})}else this.emit(p.TOUCH,{isEditing:!1,type:"pinch"});this._preScale=e.scale,this._prePanX=e.deltaX,this._prePanY=e.deltaY}}),Object.defineProperty(r.prototype,"_onPinchEndHandle",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._curPinchActiveObject=null,this._preScale=1,this._prePanX=0,this._prePanY=0,this._hammerManager.off("pinchmove",this._onPinchMoveHandle),this._hammerManager.off("pinchend",this._onPinchEndHandle),this.emit(p.TOUCH,{isEditing:!1,type:"pinch"})}}),Object.defineProperty(r.prototype,"_onDoubleTap",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.canvas.setZoom(1)}}),Object.defineProperty(r.prototype,"_onTap",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i;if(!this.canvas.getActiveObject()&&![b.WavyLine,b.Circle].includes(this._toolManager.curActionType)&&!this._isDisabled){var r=this._getPointOfViewportTransformed(e.srcEvent.offsetX,e.srcEvent.offsetY);null===(i=null===(t=this._toolManager.curTool)||void 0===t?void 0:t.mousedown)||void 0===i||i.call(t,r)}}}),Object.defineProperty(r.prototype,"_getPointOfViewportTransformed",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this.canvas.viewportTransform;return new o.Point((e-i[4])/i[0],(t-i[5])/i[3])}}),Object.defineProperty(r.prototype,"_addObjectListener",{enumerable:!1,configurable:!0,writable:!0,value:function(){g.on("".concat(this._correctId,":").concat(p.CREATE_OBJ),this._onObjectCreated.bind(this)),g.on("".concat(this._correctId,":").concat(p.DELETE_OBJ),this._onObjectRemoved.bind(this)),g.on("".concat(this._correctId,":").concat(p.EDITING_ENTERED),this._onEditingEnterText.bind(this)),g.on("".concat(this._correctId,":").concat(p.EDITING_EXITED),this._onEditingExitedText.bind(this)),this.canvas.on(p.CANVAS_IMAGE_LOADED,this._onCanvasCreateSuccess.bind(this))}}),Object.defineProperty(r.prototype,"_onEditingEnterText",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.emit(p.EDITING_ENTERED)}}),Object.defineProperty(r.prototype,"_onEditingExitedText",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.emit(p.EDITING_EXITED)}}),Object.defineProperty(r.prototype,"_onCanvasCreateSuccess",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.emit(p.READY)}}),Object.defineProperty(r.prototype,"_onObjectCreated",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._onObjectsChange("create",e)}}),Object.defineProperty(r.prototype,"_onObjectRemoved",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._onObjectsChange("delete",e)}}),Object.defineProperty(r.prototype,"_onObjectsChange",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){this.emit("create"===e?p.CREATE_OBJ:p.DELETE_OBJ,{correctId:this._correctId,target:t,objects:this.canvas.getObjects()})}}),Object.defineProperty(r.prototype,"_createCanvasEle",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=document.createElement("canvas");this._touchWrapper=document.createElement("div"),this._touchWrapper.appendChild(t);var i=document.createElement("div");return i.style.cssText="width: 100%;height: 100%;display: inline-flex;justify-content: center;align-items: center;",i.appendChild(this._touchWrapper),e.appendChild(i),t}}),Object.defineProperty(r.prototype,"_pan",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(0===e&&0===t)return!1;var i=a([],this.canvas.viewportTransform,!0),r=a([],this.canvas.viewportTransform,!0);return r[4]=r[4]+e,r[5]=r[5]+t,this.canvas.setViewportTransform(r),!(i[5]===this.canvas.viewportTransform[5])}}),Object.defineProperty(r.prototype,"_pinch",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this.canvas.getZoom()+t;this.canvas.zoomToPoint(e,i)}}),Object.defineProperty(r.prototype,"_pinchObject",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){e.set({scaleX:e.scaleX+i,scaleY:e.scaleY+i,top:e.top+t.y,left:e.left+t.x}).setCoords(),this.canvas.requestRenderAll()}}),Object.defineProperty(r.prototype,"disable",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._isDisabled=e,this.canvas.skipTargetFind=e,this.canvas.setZoom(1),this.canvas.discardActiveObject().renderAll(),this._toolManager.disable(e)}}),Object.defineProperty(r.prototype,"setCurActionTypeInfo",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._toolManager.setCurActionType(e)}}),Object.defineProperty(r.prototype,"setIconConfig",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._toolManager.setIconConfig(e)}}),Object.defineProperty(r.prototype,"curActionType",{get:function(){return this._toolManager.curActionType},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"correctId",{get:function(){return this._correctId},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._toolManager.clear()}}),Object.defineProperty(r.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e;g.off("".concat(this._correctId,":").concat(p.CREATE_OBJ),this._onObjectCreated),g.off("".concat(this._correctId,":").concat(p.DELETE_OBJ),this._onObjectRemoved),g.off("".concat(this._correctId,":").concat(p.EDITING_ENTERED),this._onEditingEnterText.bind(this)),g.off("".concat(this._correctId,":").concat(p.EDITING_EXITED),this._onEditingExitedText.bind(this)),this.canvas.off(p.CANVAS_IMAGE_LOADED,this._onCanvasCreateSuccess.bind(this)),this._hammerManager.off("pinchstart",this._onPinchStart.bind(this)),this._hammerManager.off("panstart",this._onPanStart.bind(this)),this._hammerManager.off("doubletap",this._onDoubleTap.bind(this)),this._hammerManager.off("tap",this._onTap.bind(this)),this._hammerManager.destroy(),null===(e=this._toolManager)||void 0===e||e.destroy(),this.canvas.destroy(),this.canvas=null,this._toolManager=null,this._hammerManager=null}}),Object.defineProperty(r,"VERSION",{enumerable:!0,configurable:!0,writable:!0,value:"0.0.28"}),r}(f);export{b as Controls,X as CorrectTool,p as DefinedEvents,f as EventEmitter,d as IconsInCanvas,h as Zoom,j as iconsLoaded,P as loadImage,w as preloadIcon};
